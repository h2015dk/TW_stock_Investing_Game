<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£è‚¡å¸‚æŠ•è³‡ç«¶è³½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ç™»å…¥é é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .error-msg {
            color: #e74c3c;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        /* ä¸»éŠæˆ²ä»‹é¢ */
        .game-container {
            display: none;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .status-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .status-value.cash {
            color: #27ae60;
        }

        .status-value.warning {
            color: #e74c3c;
        }

        .timer-notice {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #ffc107;
        }

        .timer-notice.urgent {
            background: #f8d7da;
            border-left-color: #e74c3c;
        }

        .timer-notice.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .timer-notice.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }

        .stocks-panel, .ranking-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .stock-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 120px;
            gap: 15px;
            align-items: center;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
        }

        .stock-code {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .stock-name {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }

        .stock-price {
            font-size: 18px;
            font-weight: 700;
            color: #27ae60;
        }

        .stock-change {
            font-size: 14px;
            margin-top: 2px;
        }

        .stock-change.up {
            color: #e74c3c;
        }

        .stock-change.down {
            color: #27ae60;
        }

        .stock-input {
            display: flex;
            flex-direction: column;
        }

        .stock-input label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stock-input input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .stock-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .stock-input input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .buy-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .buy-btn:hover {
            background: #5568d3;
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .confirm-btn, .reset-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn {
            background: #27ae60;
            color: white;
        }

        .confirm-btn:hover {
            background: #229954;
        }

        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #95a5a6;
            color: white;
        }

        .reset-btn:hover {
            background: #7f8c8d;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .ranking-item.current-player {
            background: #e8f4f8;
            border: 2px solid #667eea;
        }

        .rank-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            margin-right: 15px;
        }

        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A9A9A9);
            color: white;
        }

        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
        }

        .rank-other {
            background: #e0e0e0;
            color: #666;
        }

        .player-details {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .player-stats {
            color: #666;
            font-size: 14px;
            margin-top: 3px;
        }

        .player-score {
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }

        .update-time {
            color: #666;
            font-size: 12px;
            text-align: right;
            margin-top: 10px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stock-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h1>ğŸ† å°ç£è‚¡å¸‚æŠ•è³‡ç«¶è³½</h1>
            <p>è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿé–‹å§‹éŠæˆ²</p>
            <div class="input-group">
                <label>å¸³è™Ÿ</label>
                <input type="text" id="accountInput" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            </div>
            <div class="input-group">
                <label>ç©å®¶åç¨±</label>
                <input type="text" id="nameInput" placeholder="è«‹è¼¸å…¥ç©å®¶åç¨±">
            </div>
            <button class="login-btn" id="loginBtn">é–‹å§‹éŠæˆ²</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <!-- ä¸»éŠæˆ²ä»‹é¢ -->
    <div class="container game-container" id="gamePage">
        <div class="header">
            <h1>ğŸ† å°ç£è‚¡å¸‚æŠ•è³‡ç«¶è³½</h1>
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">ç•¶å‰æ™‚é–“</div>
                <div class="status-value" id="currentTime">--:--:--</div>
            </div>
            <div class="status-item">
                <div class="status-label">å¯ç”¨è³‡é‡‘</div>
                <div class="status-value cash" id="availableCash">$1,000,000</div>
            </div>
            <div class="status-item">
                <div class="status-label">å·²æŠ•è³‡é‡‘é¡</div>
                <div class="status-value" id="investedAmount">$0</div>
            </div>
            <div class="status-item">
                <div class="status-label">ç¸½å¸‚å€¼</div>
                <div class="status-value" id="totalValue">$1,000,000</div>
            </div>
            <div class="status-item">
                <div class="status-label">æœ¬é€±ç©åˆ†</div>
                <div class="status-value" id="weeklyScore">0</div>
            </div>
        </div>

        <!-- æ¸¬è©¦æ¨¡å¼æ§åˆ¶é¢æ¿ - åªæœ‰BCå¯è¦‹ -->
        <div id="testModePanel" style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <strong>ğŸ”§ æ¸¬è©¦æ¨¡å¼ï¼ˆåƒ…é™BCå¸³è™Ÿï¼‰</strong>
                    <span id="testModeStatus" style="margin-left: 10px; color: #666;">é—œé–‰</span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="toggleTestMode()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        é–‹å•Ÿ/é—œé–‰æ¸¬è©¦æ¨¡å¼
                    </button>
                    <button onclick="setSimulatedTime(8, 30)" style="padding: 8px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        æ¨¡æ“¬äº¤æ˜“æ™‚é–“
                    </button>
                    <button onclick="resetSimulatedTime()" style="padding: 8px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        æ¢å¾©çœŸå¯¦æ™‚é–“
                    </button>
                    <button onclick="clearGameData()" style="padding: 8px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        æ¸…é™¤æ‰€æœ‰æ•¸æ“š
                    </button>
                </div>
            </div>
        </div>

        <div id="timerNotice"></div>

        <div class="main-content">
            <div class="stocks-panel">
                <h2 class="panel-title">ğŸ“ˆ ç†±é–€è‚¡ç¥¨ (æ¯æ—¥ 8:30 æ›´æ–°)</h2>
                <div id="stocksList"></div>
                <div class="action-buttons">
                    <button class="confirm-btn" id="confirmBtn">ç¢ºèªæŠ•è³‡</button>
                    <button class="reset-btn" id="resetBtn">é‡è¨­</button>
                </div>
                <div class="update-time" id="updateTime"></div>
            </div>

            <div class="ranking-panel">
                <h2 class="panel-title">ğŸ… å³æ™‚æ’å</h2>
                <div id="rankingList"></div>
            </div>
        </div>

        <!-- æŠ•è³‡çµ„åˆé¡¯ç¤º -->
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-top: 25px;">
            <h2 class="panel-title">ğŸ’¼ æ‰€æœ‰ç©å®¶æŠ•è³‡çµ„åˆ</h2>
            <div id="portfolioDisplay"></div>
        </div>
    </div>

    <script>
        // éŠæˆ²è¨­å®š
        const ACCOUNTS = {
            'mosh': 'ç©å®¶1',
            'BC': 'ç©å®¶2',
            'è€é—†': 'ç©å®¶3',
            'æ›¸ç‘‹': 'ç©å®¶4',
            'å¿ æ†²': 'ç©å®¶5',
            'å¼µæŠ€å¸«': 'ç©å®¶6'
        };

        const INITIAL_CASH = 1000000;
        const SCORE_MAP = [10, 7, 6, 2, 0, -1];
        const FRIDAY_MULTIPLIER = 2;
        
        // ğŸ”§ æ¸¬è©¦æ¨¡å¼é–‹é—œ - è¨­ç‚º true å¯éš¨æ™‚äº¤æ˜“
        let TEST_MODE = false;
        
        // æ¸¬è©¦ç”¨çš„æ¨¡æ“¬æ™‚é–“
        let simulatedTime = null;

        // 10éš»å°ç£ç†±é–€è‚¡ç¥¨
        let stocks = [
            { code: '2330', name: 'å°ç©é›»', price: 685, change: 2.5 },
            { code: '2317', name: 'é´»æµ·', price: 156, change: -1.2 },
            { code: '2454', name: 'è¯ç™¼ç§‘', price: 1095, change: 3.8 },
            { code: '2308', name: 'å°é”é›»', price: 368, change: 1.5 },
            { code: '2303', name: 'è¯é›»', price: 48.5, change: -0.5 },
            { code: '2882', name: 'åœ‹æ³°é‡‘', price: 62.8, change: 0.8 },
            { code: '2412', name: 'ä¸­è¯é›»', price: 125, change: 0.3 },
            { code: '2881', name: 'å¯Œé‚¦é‡‘', price: 89.5, change: -0.7 },
            { code: '6505', name: 'å°å¡‘åŒ–', price: 98.2, change: 1.1 },
            { code: '1301', name: 'å°å¡‘', price: 102, change: 0.9 }
        ];

        let currentUser = null;
        let gameData = loadGameData();

        // ç­‰å¾… DOM åŠ è¼‰å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢å·²è¼‰å…¥');
            
            // ç¶å®šç™»å…¥æŒ‰éˆ•
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
                console.log('ç™»å…¥æŒ‰éˆ•å·²ç¶å®š');
            }
            
            // ç¶å®šç™»å‡ºæŒ‰éˆ•
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('ç™»å‡ºæŒ‰éˆ•å·²ç¶å®š');
            }
            
            // ç¶å®šç¢ºèªæŠ•è³‡æŒ‰éˆ•
            const confirmBtn = document.getElementById('confirmBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('ç¢ºèªæŠ•è³‡æŒ‰éˆ•äº‹ä»¶è§¸ç™¼');
                    confirmInvestment();
                });
                console.log('ç¢ºèªæŠ•è³‡æŒ‰éˆ•å·²ç¶å®š');
            }
            
            // ç¶å®šé‡è¨­æŒ‰éˆ•
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetInvestment);
                console.log('é‡è¨­æŒ‰éˆ•å·²ç¶å®š');
            }
            
            // é–‹å§‹æ™‚é˜
            setInterval(updateTime, 1000);
            setInterval(updateTimerNotice, 60000);
            updateTime();
            
            console.log('æ‰€æœ‰äº‹ä»¶ç›£è½å™¨å·²ç¶å®š');
        });

        // è¼‰å…¥éŠæˆ²æ•¸æ“š
        function loadGameData() {
            console.log('è¼‰å…¥éŠæˆ²æ•¸æ“š...');
            const saved = localStorage.getItem('stockGameData');
            const data = saved ? JSON.parse(saved) : {};
            
            console.log('å¾ localStorage è¼‰å…¥çš„æ•¸æ“š:', data);
            
            // ç¢ºä¿æ‰€æœ‰ç©å®¶éƒ½æœ‰æ•¸æ“šçµæ§‹
            Object.keys(ACCOUNTS).forEach(account => {
                if (!data[account]) {
                    console.log(`åˆå§‹åŒ– ${account} çš„æ•¸æ“š`);
                    data[account] = {
                        name: ACCOUNTS[account],
                        cash: INITIAL_CASH,
                        investments: {},
                        totalValue: INITIAL_CASH,
                        weeklyScore: 0
                    };
                } else {
                    // ç¢ºä¿ç¾æœ‰ç©å®¶æœ‰ investments å±¬æ€§
                    if (!data[account].investments) {
                        console.log(`ç‚º ${account} æ·»åŠ  investments å±¬æ€§`);
                        data[account].investments = {};
                    }
                }
            });
            
            console.log('æœ€çµ‚éŠæˆ²æ•¸æ“š:', data);
            return data;
        }

        // ä¿å­˜éŠæˆ²æ•¸æ“š
        function saveGameData() {
            console.log('ä¿å­˜éŠæˆ²æ•¸æ“šåˆ° localStorage:', gameData);
            localStorage.setItem('stockGameData', JSON.stringify(gameData));
            console.log('ä¿å­˜å®Œæˆ');
        }

        // è™•ç†ç™»å…¥
        function handleLogin() {
            console.log('ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š');
            
            const account = document.getElementById('accountInput').value.trim();
            const name = document.getElementById('nameInput').value.trim();
            const errorMsg = document.getElementById('errorMsg');

            // é‡ç½®éŒ¯èª¤è¨Šæ¯
            errorMsg.style.display = 'none';

            // é©—è­‰è¼¸å…¥
            if (!account || !name) {
                errorMsg.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œç©å®¶åç¨±';
                errorMsg.style.display = 'block';
                return;
            }

            // é©—è­‰å¸³è™Ÿ
            if (!ACCOUNTS[account]) {
                errorMsg.textContent = 'å¸³è™ŸéŒ¯èª¤ï¼Œç„¡æ³•é€²è¡ŒéŠæˆ²';
                errorMsg.style.display = 'block';
                return;
            }

            currentUser = {
                account: account,
                name: name
            };

            // æ›´æ–°ç©å®¶åç¨±
            gameData[account].name = name;
            saveGameData();

            // é¡¯ç¤ºéŠæˆ²é é¢
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('gamePage').style.display = 'block';
            document.getElementById('userName').textContent = name;

            // åˆå§‹åŒ–éŠæˆ²
            initGame();
            
            console.log('å·²é€²å…¥éŠæˆ²');
        }

        // è™•ç†ç™»å‡º
        function handleLogout() {
            currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('gamePage').style.display = 'none';
            document.getElementById('accountInput').value = '';
            document.getElementById('nameInput').value = '';
        }

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            // åªæœ‰BCå¯ä»¥ä½¿ç”¨æ¸¬è©¦æ¨¡å¼
            if (currentUser.account === 'BC') {
                document.getElementById('testModePanel').style.display = 'block';
            } else {
                document.getElementById('testModePanel').style.display = 'none';
            }
            
            updateStocksList();
            updatePlayerStatus();
            updateRankings();
            updateTimerNotice();
            updatePortfolioDisplay();
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = simulatedTime || new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            const timeDisplay = simulatedTime ? `ğŸ”§ ${timeString}` : timeString;
            document.getElementById('currentTime').textContent = timeDisplay;
        }

        // æ›´æ–°è‚¡ç¥¨åˆ—è¡¨
        function updateStocksList() {
            const container = document.getElementById('stocksList');
            const player = gameData[currentUser.account];
            const now = simulatedTime || new Date();
            const canTrade = checkTradingTime(now);
            
            container.innerHTML = stocks.map(stock => `
                <div class="stock-item">
                    <div class="stock-info">
                        <div class="stock-code">${stock.code}</div>
                        <div class="stock-name">${stock.name}</div>
                    </div>
                    <div>
                        <div class="stock-price">$${stock.price.toFixed(2)}</div>
                        <div class="stock-change ${stock.change >= 0 ? 'up' : 'down'}">
                            ${stock.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(stock.change)}%
                        </div>
                    </div>
                    <div class="stock-input">
                        <label>è³¼è²·è‚¡æ•¸</label>
                        <input type="number" 
                               id="shares_${stock.code}" 
                               min="0" 
                               value="${player.investments[stock.code] || 0}"
                               onchange="calculateInvestment()"
                               ${canTrade ? '' : 'disabled'}>
                    </div>
                    <button class="buy-btn" 
                            onclick="quickBuy('${stock.code}')"
                            ${canTrade ? '' : 'disabled'}>
                        å¿«é€Ÿ+10
                    </button>
                </div>
            `).join('');

            const updateTimeEl = document.getElementById('updateTime');
            updateTimeEl.textContent = `æœ€å¾Œæ›´æ–°: ${now.toLocaleString('zh-TW')}`;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('confirmBtn').disabled = !canTrade;
        }

        // æª¢æŸ¥äº¤æ˜“æ™‚é–“
        function checkTradingTime(now) {
            // ğŸ”§ æ¸¬è©¦æ¨¡å¼ï¼šæ°¸é è¿”å› true
            if (TEST_MODE) {
                return true;
            }
            
            // å¦‚æœæœ‰æ¨¡æ“¬æ™‚é–“ï¼Œä½¿ç”¨æ¨¡æ“¬æ™‚é–“
            if (simulatedTime) {
                now = simulatedTime;
            }
            
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // é€±ä¸€åˆ°é€±äº”
            if (day >= 1 && day <= 5) {
                // 8:00 åˆ° 8:59
                if (hour === 8 && minute < 59) {
                    return true;
                }
            }
            return false;
        }

        // å¿«é€Ÿè²·å…¥
        function quickBuy(code) {
            const input = document.getElementById(`shares_${code}`);
            const currentShares = parseInt(input.value) || 0;
            input.value = currentShares + 10;
            calculateInvestment();
        }

        // è¨ˆç®—æŠ•è³‡é‡‘é¡
        function calculateInvestment() {
            let totalInvested = 0;

            stocks.forEach(stock => {
                const shares = parseInt(document.getElementById(`shares_${stock.code}`).value) || 0;
                if (shares > 0) {
                    totalInvested += shares * stock.price;
                }
            });

            const availableCash = INITIAL_CASH - totalInvested;
            
            const cashEl = document.getElementById('availableCash');
            cashEl.textContent = `$${Math.max(0, availableCash).toLocaleString()}`;
            
            document.getElementById('investedAmount').textContent = 
                `$${totalInvested.toLocaleString()}`;

            // å¦‚æœè¶…é¡ï¼Œæ¨™è¨˜ç´…è‰²
            if (availableCash < 0) {
                cashEl.classList.add('warning');
                cashEl.classList.remove('cash');
            } else {
                cashEl.classList.add('cash');
                cashEl.classList.remove('warning');
            }
        }

        // ç¢ºèªæŠ•è³‡
        function confirmInvestment() {
            console.log('=== é–‹å§‹ç¢ºèªæŠ•è³‡ ===');
            console.log('ç•¶å‰ç”¨æˆ¶:', currentUser);
            
            const player = gameData[currentUser.account];
            console.log('ç©å®¶æ•¸æ“š:', player);
            
            const now = simulatedTime || new Date();

            if (!checkTradingTime(now)) {
                alert('âš ï¸ ç›®å‰ä¸åœ¨äº¤æ˜“æ™‚é–“ï¼ˆé€±ä¸€è‡³é€±äº” 8:00-8:59ï¼‰\næç¤ºï¼šBCå¸³è™Ÿå¯ä»¥ä½¿ç”¨æ¸¬è©¦æ¨¡å¼ä¾†éš¨æ™‚äº¤æ˜“');
                return;
            }

            let totalInvested = 0;
            const newInvestments = {};
            let allStocksHaveShares = true;

            console.log('é–‹å§‹è®€å–è‚¡ç¥¨è¼¸å…¥...');
            stocks.forEach(stock => {
                const inputElement = document.getElementById(`shares_${stock.code}`);
                const shares = parseInt(inputElement?.value) || 0;
                console.log(`${stock.code} ${stock.name}: ${shares} è‚¡`);
                
                if (shares > 0) {
                    totalInvested += shares * stock.price;
                    newInvestments[stock.code] = shares;
                } else {
                    allStocksHaveShares = false;
                }
            });

            console.log('ç¸½æŠ•è³‡é‡‘é¡:', totalInvested);
            console.log('æ–°æŠ•è³‡çµ„åˆ:', newInvestments);
            console.log('æ‰€æœ‰è‚¡ç¥¨éƒ½æœ‰è²·å—?', allStocksHaveShares);

            // æª¢æŸ¥æ˜¯å¦æ¯æ”¯è‚¡ç¥¨è‡³å°‘è²·1è‚¡
            if (!allStocksHaveShares) {
                const missingStocks = stocks.filter(s => !newInvestments[s.code]).map(s => s.name);
                console.log('ç¼ºå°‘çš„è‚¡ç¥¨:', missingStocks);
                if (!confirm(`âš ï¸ è¦å‰‡è¦æ±‚æ¯æ”¯è‚¡ç¥¨è‡³å°‘è¦è²·ä¸€è‚¡ä»¥ä¸Šï¼\n\nå°šæœªè³¼è²·çš„è‚¡ç¥¨ï¼š${missingStocks.join('ã€')}\n\næ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                    console.log('ç”¨æˆ¶å–æ¶ˆæŠ•è³‡');
                    return;
                }
            }

            if (totalInvested > INITIAL_CASH) {
                alert('âŒ æŠ•è³‡é‡‘é¡è¶…éå¯ç”¨è³‡é‡‘ï¼');
                console.log('æŠ•è³‡é‡‘é¡è¶…é¡');
                return;
            }

            // ä¿å­˜æŠ•è³‡
            console.log('ä¿å­˜å‰ - ç©å®¶æŠ•è³‡çµ„åˆ:', player.investments);
            player.investments = newInvestments;
            player.cash = INITIAL_CASH - totalInvested;
            console.log('ä¿å­˜å¾Œ - ç©å®¶æŠ•è³‡çµ„åˆ:', player.investments);
            console.log('ä¿å­˜å¾Œ - ç©å®¶ç¾é‡‘:', player.cash);
            
            saveGameData();
            console.log('æ•¸æ“šå·²ä¿å­˜åˆ° localStorage');
            
            // é©—è­‰ä¿å­˜
            const savedData = JSON.parse(localStorage.getItem('stockGameData'));
            console.log('é©—è­‰ localStorage ä¸­çš„æ•¸æ“š:', savedData[currentUser.account]);

            alert(`âœ… æŠ•è³‡ç¢ºèªæˆåŠŸï¼\n\nå·²æŠ•è³‡: $${totalInvested.toLocaleString()}\nå‰©é¤˜ç¾é‡‘: $${player.cash.toLocaleString()}`);
            
            // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
            console.log('é–‹å§‹æ›´æ–°é¡¯ç¤º...');
            updatePlayerStatus();
            updateRankings();
            updatePortfolioDisplay();
            console.log('=== æŠ•è³‡ç¢ºèªå®Œæˆ ===');
        }

        // é‡è¨­æŠ•è³‡
        function resetInvestment() {
            console.log('é‡è¨­æŠ•è³‡');
            stocks.forEach(stock => {
                const input = document.getElementById(`shares_${stock.code}`);
                if (input) input.value = 0;
            });
            calculateInvestment();
        }

        // æ›´æ–°ç©å®¶ç‹€æ…‹
        function updatePlayerStatus() {
            const player = gameData[currentUser.account];
            let totalValue = player.cash || INITIAL_CASH;

            Object.entries(player.investments || {}).forEach(([code, shares]) => {
                const stock = stocks.find(s => s.code === code);
                if (stock) {
                    totalValue += shares * stock.price;
                }
            });

            player.totalValue = totalValue;
            
            document.getElementById('totalValue').textContent = 
                `$${totalValue.toLocaleString()}`;
            document.getElementById('weeklyScore').textContent = 
                player.weeklyScore || 0;

            saveGameData();
        }

        // æ›´æ–°æ’å
        function updateRankings() {
            const rankings = Object.entries(gameData)
                .map(([account, player]) => ({
                    account,
                    name: player.name,
                    totalValue: player.totalValue || INITIAL_CASH,
                    score: player.weeklyScore || 0
                }))
                .sort((a, b) => b.totalValue - a.totalValue);

            const container = document.getElementById('rankingList');
            container.innerHTML = rankings.map((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : 
                                 index === 1 ? 'rank-2' : 
                                 index === 2 ? 'rank-3' : 'rank-other';
                
                return `
                    <div class="ranking-item ${player.account === currentUser.account ? 'current-player' : ''}">
                        <div class="rank-number ${rankClass}">${index + 1}</div>
                        <div class="player-details">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">
                                å¸‚å€¼: $${player.totalValue.toLocaleString()}
                            </div>
                        </div>
                        <div class="player-score">${player.score}åˆ†</div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°æŠ•è³‡çµ„åˆé¡¯ç¤º
        function updatePortfolioDisplay() {
            console.log('=== æ›´æ–°æŠ•è³‡çµ„åˆé¡¯ç¤º ===');
            const container = document.getElementById('portfolioDisplay');
            
            let html = '<div style="display: grid; gap: 20px;">';
            
            Object.entries(gameData).forEach(([account, player]) => {
                console.log(`ç©å®¶ ${account} (${player.name}):`, player);
                console.log(`  æŠ•è³‡çµ„åˆ:`, player.investments);
                
                const isCurrentPlayer = account === currentUser.account;
                const investments = player.investments || {};
                const hasInvestments = Object.keys(investments).length > 0;
                
                console.log(`  æ˜¯ç•¶å‰ç©å®¶: ${isCurrentPlayer}`);
                console.log(`  æœ‰æŠ•è³‡: ${hasInvestments}`);
                console.log(`  æŠ•è³‡é …ç›®æ•¸é‡: ${Object.keys(investments).length}`);
                
                html += `
                    <div style="background: ${isCurrentPlayer ? '#e8f4f8' : '#f8f9fa'}; padding: 20px; border-radius: 10px; border: ${isCurrentPlayer ? '2px solid #667eea' : '1px solid #e0e0e0'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #333; margin: 0;">
                                ${player.name} ${isCurrentPlayer ? '(ä½ )' : ''}
                            </h3>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666;">ç¾é‡‘</div>
                                <div style="font-size: 18px; font-weight: 700; color: #27ae60;">
                                    $${(player.cash || INITIAL_CASH).toLocaleString()}
                                </div>
                            </div>
                        </div>
                `;
                
                if (hasInvestments) {
                    console.log(`  é–‹å§‹é¡¯ç¤º ${Object.keys(investments).length} é …æŠ•è³‡`);
                    html += '<div style="display: grid; gap: 10px;">';
                    
                    Object.entries(investments).forEach(([code, shares]) => {
                        console.log(`    ${code}: ${shares} è‚¡`);
                        const stock = stocks.find(s => s.code === code);
                        if (stock && shares > 0) {
                            const value = shares * stock.price;
                            console.log(`      æ‰¾åˆ°è‚¡ç¥¨è³‡æ–™ï¼Œåƒ¹å€¼: ${value}`);
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 5px;">
                                    <div>
                                        <span style="font-weight: 700; color: #333;">${stock.code}</span>
                                        <span style="color: #666; margin-left: 10px;">${stock.name}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; color: #666;">${shares} è‚¡ Ã— $${stock.price.toFixed(2)}</div>
                                        <div style="font-size: 16px; font-weight: 700; color: #667eea;">
                                            $${value.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            console.log(`      æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™æˆ–è‚¡æ•¸ç‚º0`);
                        }
                    });
                    
                    html += '</div>';
                } else {
                    console.log(`  é¡¯ç¤ºï¼šå°šæœªæŠ•è³‡`);
                    html += `
                        <div style="text-align: center; padding: 20px; color: #999;">
                            å°šæœªæŠ•è³‡ä»»ä½•è‚¡ç¥¨
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
            console.log('=== æŠ•è³‡çµ„åˆé¡¯ç¤ºæ›´æ–°å®Œæˆ ===');
        }

        // æ›´æ–°æ™‚é–“æç¤º
        function updateTimerNotice() {
            const now = simulatedTime || new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const day = now.getDay();
            const container = document.getElementById('timerNotice');

            // é€±ä¸€åˆ°é€±äº”
            if (day >= 1 && day <= 5) {
                // é€±äº”ç‰¹åˆ¥æç¤º
                if (day === 5) {
                    container.innerHTML = `
                        <div class="timer-notice success">
                            â­ ä»Šæ—¥æ˜¯é€±äº”ï¼ç©åˆ†åŠ å€æ—¥ï¼ â­
                        </div>
                    `;
                }
                
                if (hour < 8) {
                    container.innerHTML += `
                        <div class="timer-notice info">
                            â° ä»Šæ—¥è³‡é‡‘å°‡æ–¼ 8:00 ç™¼æ”¾ï¼Œ8:30 è‚¡ç¥¨æ•¸æ“šæ›´æ–°
                        </div>
                    `;
                } else if (hour === 8 && minute < 30) {
                    container.innerHTML = `
                        <div class="timer-notice urgent">
                            âš ï¸ è«‹åœ¨ 8:59 å‰å®ŒæˆæŠ•è³‡åˆ†é…ï¼å‰©é¤˜æ™‚é–“: ${59 - minute} åˆ†é˜
                        </div>
                    `;
                } else if (hour === 8 && minute >= 30 && minute < 59) {
                    container.innerHTML = `
                        <div class="timer-notice urgent">
                            âš ï¸ æœ€å¾ŒæŠ•è³‡æ™‚é–“ï¼å‰©é¤˜ ${59 - minute} åˆ†é˜
                        </div>
                    `;
                } else if (hour < 14) {
                    container.innerHTML = `
                        <div class="timer-notice">
                            ğŸ“Š äº¤æ˜“å·²æˆªæ­¢ï¼Œç­‰å¾… 14:00 çµç®—
                        </div>
                    `;
                } else if (hour < 17) {
                    container.innerHTML = `
                        <div class="timer-notice">
                            âœ… ä»Šæ—¥å·²çµç®—å®Œæˆï¼Œ17:00 å¸‚å€¼å°‡æ­¸é›¶
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="timer-notice">
                            ğŸ’¤ ä»Šæ—¥å·²çµæŸï¼Œæ˜æ—¥ 8:00 é–‹å§‹æ–°çš„ä¸€å¤©
                        </div>
                    `;
                }
            } else {
                container.innerHTML = `
                    <div class="timer-notice">
                        ğŸ–ï¸ é€±æœ«ä¼‘æ¯ä¸­ï¼Œé€±ä¸€ 8:00 è¦‹ï¼
                    </div>
                `;
            }
        }
        
        // ğŸ”§ æ¸¬è©¦æ¨¡å¼æ§åˆ¶å‡½æ•¸
        function toggleTestMode() {
            TEST_MODE = !TEST_MODE;
            const statusEl = document.getElementById('testModeStatus');
            if (TEST_MODE) {
                statusEl.textContent = 'âœ… é–‹å•Ÿï¼ˆå¯éš¨æ™‚äº¤æ˜“ï¼‰';
                statusEl.style.color = '#27ae60';
                alert('âœ… æ¸¬è©¦æ¨¡å¼å·²é–‹å•Ÿï¼ç¾åœ¨å¯ä»¥éš¨æ™‚äº¤æ˜“è‚¡ç¥¨ã€‚');
            } else {
                statusEl.textContent = 'âŒ é—œé–‰';
                statusEl.style.color = '#e74c3c';
                alert('âŒ æ¸¬è©¦æ¨¡å¼å·²é—œé–‰ï¼Œæ¢å¾©æ­£å¸¸äº¤æ˜“æ™‚é–“é™åˆ¶ã€‚');
            }
            updateStocksList();
            updateTimerNotice();
        }
        
        function setSimulatedTime(hour, minute) {
            simulatedTime = new Date();
            simulatedTime.setHours(hour, minute, 0);
            alert(`â° å·²è¨­å®šæ¨¡æ“¬æ™‚é–“ç‚º ${hour}:${minute < 10 ? '0' + minute : minute}`);
            updateStocksList();
            updateTimerNotice();
        }
        
        function resetSimulatedTime() {
            simulatedTime = null;
            alert('â° å·²æ¢å¾©çœŸå¯¦æ™‚é–“');
            updateStocksList();
            updateTimerNotice();
        }
        
        function clearGameData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŠæˆ²æ•¸æ“šå—ï¼Ÿ\né€™å°‡é‡ç½®æ‰€æœ‰ç©å®¶çš„æŠ•è³‡å’Œç©åˆ†ï¼')) {
                console.log('æ¸…é™¤ localStorage æ•¸æ“š');
                localStorage.removeItem('stockGameData');
                gameData = loadGameData();
                console.log('æ•¸æ“šå·²é‡ç½®:', gameData);
                alert('âœ… æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ä¸¦é‡ç½®ï¼');
                updateStocksList();
                updatePlayerStatus();
                updateRankings();
                updatePortfolioDisplay();
            }
        }
    </script>
</body>
</html>